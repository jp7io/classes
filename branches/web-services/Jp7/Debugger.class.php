<?php
/**
 * JP7's PHP Functions 
 * 
 * Contains the main custom functions and classes.
 * @author JP7
 * @copyright Copyright 2002-2008 JP7 (http://jp7.com.br)
 * @category Jp7
 * @package Jp7_Debugger
 */
 
/**
 * Debug class, used to display filenames, processing time and display formatted SQL queries.
 *
 * @package Jp7_Debugger
 */
class Jp7_Debugger{
	/**
	 * Flag, it is <tt>TRUE</tt> if its displaying filenames or SQL queries.
	 * @var bool
	 */
	public $active;
	/**
	 * Flag indicating if filenames will be showed or not. Use $_GET['debug_filename'] to set it.
	 * @var bool 
	 */
	public $debugFilename;
	/**
	 * Flag indicating if the SQL queries will be showed or not. Use $_GET['debug_sql'] to set it.
	 * @var bool
	 */
	public $debugSql;
	/**
	 * In order to prevent errors with output and headers, set this variable <tt>TRUE</tt> after the headers are sent.
	 * @var bool 
	 */
	protected $_safePoint;
	/**
	 * Array containing the activity log for queries, filenames and their processing time.
	 * @var array 
	 */
	protected $_log;
	/**
	 * Stores the start time which is used to calculate the processing time. Use the method startTime() to set this variable.
	 * @var float|array
	 */
	protected $_startTime;
	/**
	 * Indicates the current template file loaded. Used on the showToolbar() method.
	 * @var bool
	 */
	protected $_templateFilename;
	protected $_exceptionsEnabled = false;
	/**
	 * Public Constructor, it checks the flags and settings, will do nothing if $c_jp7 is <tt>FALSE</tt>.
	 *
	 * @global bool
	 */	
	public function __construct() {
		global $c_jp7;
		if (!$c_jp7) return; // Only by Devs
		$this->startTime();
		// Debug - SQL
		$this->debugSql = $_GET['debug_sql'];
		// Debug - Filename
		if (isset($_GET['debug_filename'])) {
			setcookie('debug_filename', $_GET['debug_filename'], 0, '/');
			$_COOKIE['debug_filename'] = $_GET['debug_filename'];
		}
		if ($_COOKIE['debug_filename']) $this->debugFilename = $_COOKIE['debug_filename'];
		// Debug - Toolbar
		if (isset($_GET['debug_toolbar'])){
			setcookie('debug_toolbar', $_GET['debug_toolbar'], 0, '/');
			$_COOKIE['debug_toolbar'] = $_GET['debug_toolbar'];
		}
		// Setting it as active
		if ($_COOKIE['debug_toolbar'] || $this->debugSql || $this->debugFilename) $this->active = true;
	}
	/**
	 * Starts recording the time spent on the code. When using more than one startTime(), the time will be displayed from the last to the first when getTime() is called.
	 *
	 * @return void
	 */	
	public function startTime() {
		$debug_mtime = explode(' ', microtime());
		$this->_startTime[] = $debug_mtime[1] + $debug_mtime[0];
	}
	/**
	 * Calculates and displays the time spent from the moment startTime() was called.
	 *
	 * @param bool Sets whether the time will be outputted or not.
	 * @return void
	 */	
	public function getTime($output = FALSE) {
		if (!count($this->_startTime)) return;
		$debug_mtime = explode(' ', microtime());
		// Retrieves and deletes the last value
		$debug_starttime = array_pop($this->_startTime);
		$debug_totaltime = round(($debug_mtime[0] + $debug_mtime[1] - $debug_starttime) * 1000);
		if ($output && $this->isSafePoint()) echo '<div class="debug_msg">Processed in: ' . $debug_totaltime . 'ms.</div>';
		return $debug_totaltime;
	}
	/**
	 * Shows the filename if $safePoint and $debugFilename are <tt>TRUE</tt>. Adds the filename to $_log.
	 *
	 * @param string $filename Name of the file.
	 * @return string Returns the $filename value unchanged.
	 * @global string
	 */	
	public function showFilename($filename) {
		global $c_doc_root;
		if ($this->debugFilename && $this->isSafePoint()) echo '<div class="debug_msg">' .  str_replace($c_doc_root, '/', $filename ) . '</div>';
		if ($this->active) {
			// Creates a new log entry for this file
			$this->addLog($filename, 'file');
		}
		return $filename;
	}
	/**
	 * Formats and displays an SQL query.
	 *
	 * @param string $sql SQL query to be formatted and displayed.
	 * @param bool $forceDebug If <tt>TRUE</tt> it will show the SQL even when $_GET['debug_sql'] is not set, the default value is <tt>FALSE</tt>.
	 * @param string Stylesheet on the box displayed. The default value is ''.
	 * @return void
	 */	
	public function showSql($sql, $forceDebug = false, $style = '') {
		if ($forceDebug) {
			ob_flush();
		}
		if (!$this->isSafePoint()) return;
		if ($this->debugSql || $forceDebug) echo '<div class="debug_sql" style="' . $style . '">' . preg_replace('/(SELECT | FROM | WHERE | ORDER BY |HAVING|GROUP BY|LEFT JOIN)/','<b>\1</b>', $sql) . '</div>';
	}
	/**
	 * Formats and returns the backtrace.
	 *
	 * @param string $msgErro Error message (optional).
	 * @param string $sql SQL query which was executed (optional).
	 * @param array $backtrace Backtrace generated by debug_backtrace() (optional).
 	 * @return string Formatted HTML backtrace.
	 */	
	public function getBacktrace($msgErro = NULL, $sql = NULL, $backtrace = NULL) {
		global $c_doc_root;
		if (!$backtrace) $backtrace = debug_backtrace();
		krsort($backtrace);
		
		$S = '';
		if ($msgErro) {
			$S .= $this->_getBacktraceLabel('ERRO') . wordwrap($msgErro, 85, "\n") . "\n";
		}
		$S .= '<hr />';
		$S .= $this->_getBacktraceLabel('CALL STACK') . '<br />';
		$S .= '<table id="jp7_debugger_table"><tr><th>#</th><th>Function</th><th>Location</th></tr>';
		foreach ($backtrace as $key => $row) {
			$S .= '<tr><td>' . (count($backtrace) - $key) . '</td>';
			$S .= '<td>' . $row['class'] . $row['type'] . $row['function'] . '()</td>';
			$S .= '<td>' . str_replace(str_replace('/', '\\', $c_doc_root), '', $row['file']) . ':' . $row['line'] . '</td></tr>';
		}
		$S .= '</table>';
		
		$S .= '<hr />';
		if ($sql) {
			$S .= $this->_getBacktraceLabel('SQL') . preg_replace(array('/( FROM )/','/( WHERE )/','/( ORDER BY )/'), "\n" . '            \1', $sql)  . "\n";
		}
		$S .= $this->_getBacktraceLabel('URL') . (($_SERVER['HTTPS'] == 'on') ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] . "\n";
		if ($_SERVER['HTTP_REFERER']) {
			$S .= $this->_getBacktraceLabel('REFERER') . $_SERVER['HTTP_REFERER'] . "\n";
		}
		$S .= $this->_getBacktraceLabel('IP CLIENTE') . $_SERVER['REMOTE_ADDR'] . "\n";
		$S .= $this->_getBacktraceLabel('IP SERVIDOR') . $_SERVER['SERVER_ADDR'] . "\n";
		$S .= $this->_getBacktraceLabel('USER_AGENT') . $_SERVER['HTTP_USER_AGENT'] . "\n";
		$S .= '<hr />';
		$S .= $this->_getBacktraceLabel('BACKTRACE') . print_r($backtrace, true);
		if (count($_POST)) {
			$S .= $this->_getBacktraceLabel('POST') . print_r($_POST, true);	
		}
		if (count($_GET)) {
			$S .= $this->_getBacktraceLabel('GET') . print_r($_GET, true);
		}
		if (count($_SESSION)) {
			$S .= $this->_getBacktraceLabel('SESSION') . print_r($_SESSION, true);
		}
		if (count($_COOKIE)) {
			$S .= $this->_getBacktraceLabel('COOKIE') . print_r($_COOKIE, true);
		}
		return '<pre style="background-color:#FFFFFF;font-size:11px;text-align:left;">' . $S . '</pre>';
	}
	
	/**
	 * Adds padding and html formatting to the backtrace label.
	 *
	 * @param string $caption Label caption.
	 * @return string Formatted label.
	 */
	protected function _getBacktraceLabel($caption) {
		return '<strong style="color:red">'. str_pad($caption, 12, ' ', STR_PAD_LEFT) . ':</strong> ';
	}
	/**
	 * @param bool
	 * @return void
	 */
	public function setExceptionsEnabled($bool) {
		$this->_exceptionsEnabled = $bool;
	}
	/**
	 * @return bool
	 */
	public function isExceptionsEnabled() {
		return $this->_exceptionsEnabled;
	}
	/**
	 * Method to be used as default error handler with set_error_handler() function.
	 *
	 * @param $code Error type code, like E_STRICT, E_NOTICE and so on.
	 * @param $msgErro Error message.
	 * @return bool
	 */
	public function errorHandler($code, $msgErro) {
		if ($code == E_STRICT || $code == E_NOTICE || $code == E_DEPRECATED) {
			return false; // FALSE -> the default error handler will take care of it.
		}
		if (error_reporting() == 0) {
			return false; // Programmer used @ so the error reporting value is 0.
		}

		$backtrace = debug_backtrace();
		array_shift($backtrace);
		die(jp7_debug($msgErro, NULL, $backtrace));
	}
	/**
	 * Adds a log to the $_log array.
	 *
	 * @param string $value Value to be displayed.
	 * @param string $tag Tag which represents the type of data stored.
	 * @param int $time Time this proccess took in miliseconds, e.g. ammount of time a SQL query took to be executed.
 	 * @return void
	 */	
	public function addLog($value, $tag = 'log', $time = NULL) {
		$this->_log[] = array('tag' => $tag, 'value' => $value, 'time' => $time);
	}
	/**
	 * Returns the log array.
	 *
	 * @param string $value Value to be displayed.
	 * @param string $tag Tag which represents the type of data stored.
	 * @param int $time Time this proccess took in miliseconds, e.g. ammount of time a SQL query took to be executed.
 	 * @return array Returns the value of $_log.
	 */
	public function getLog() {
		return $this->_log;
	} 
	/**
	 * Sets the filename of the current template.
	 *
	 * @param string $filename Name of the current template file.
 	 * @return void
	 */
	public function setTemplateFilename($filename) {
		$this->_templateFilename = $filename;
	}
	/**
	 * Returns the filename of the current template.
	 *
 	 * @return string Name of the current template file.
	 */
	public function getTemplateFilename() {
		return $this->_templateFilename;
	}
	/**
	 * Displays current template, log data, and time for the page.
	 *
 	 * @return void
	 */
	public function showToolbar() {
		if (!$this->active || !$this->isSafePoint()) return;
		
		if ($this->_templateFilename ) echo ('Template: ' . $this->_templateFilename);
		else echo('PHP_SELF: ' . $_SERVER['PHP_SELF']);
		
		jp7_print_r($this->_log);
		$this->getTime(true);
	}
	public function isSafePoint() {
		return $this->_savePoint || headers_sent();
	}
	public function setSafePoint($bool) {
		$this->_savePoint = $bool;
	}
}
